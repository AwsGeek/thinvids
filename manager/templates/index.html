{% extends "base.html" %}
{% block title %}Trans the Vids!{% endblock %}
{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    /* Single-line everywhere by default */
    #job-table th, #job-table td { white-space: nowrap; vertical-align: middle; }

    /* Fixed widths for progress columns (match w-28 / 7rem) */
    #job-table col.progress-col { width: 7rem; }

    /* Keep other, non-Name columns as tight as possible */
    #job-table col.shrink { width: 1%; }

    /* Name column: takes remaining space; inner element ellipsizes */
    #job-table td.name-cell { width: auto; }
    #job-table .name-clip { display: block; max-width: 100%; }
    #job-table .name-text {
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: bottom;
    }

    /* Progress bar container uses full cell width (7rem via colgroup) */
    .prog-wrap { width: 100%; }

    /* Slightly denser rows */
    #job-table th, #job-table td { padding-top: .25rem; padding-bottom: .25rem; }
  </style>
{% endblock %}

{% block content %}

<!-- top mini-charts -->
<div class="grid grid-cols-3 gap-6">
  <div class="bg-white rounded shadow p-4">
    <div class="flex items-baseline justify-between"><h3 class="font-semibold">GPU %</h3><span id="gpu-updated" class="text-xs text-gray-500"></span></div>
    <div class="w-full h-20"><canvas id="gpuChart" class="w-full h-full"></canvas></div>
  </div>
  <div class="bg-white rounded shadow p-4">
    <div class="flex items-baseline justify-between"><h3 class="font-semibold">CPU %</h3><span id="cpu-updated" class="text-xs text-gray-500"></span></div>
    <div class="w-full h-20"><canvas id="cpuChart" class="w-full h-full"></canvas></div>
  </div>

  <!-- NET MINI -->
  <div class="bg-white rounded shadow p-4">
    <div class="flex items-baseline justify-between">
      <h3 class="font-semibold">Network</h3>
      <span id="net-updated" class="text-xs text-gray-500"></span>
    </div>
    <div class="w-full h-20"><canvas id="netMiniChart" class="w-full h-full"></canvas></div>
  </div>
</div>

<h2 class="text-xl font-semibold my-2">Current Jobs</h2>

<table id="job-table" class="w-full border-collapse bg-white">
  <!-- Column sizing: most are tiny; Name grows; progress fixed -->
  <colgroup>
    <col class="shrink"><!-- ID -->
    <col><!-- Name (flex) -->
    <col class="shrink"><!-- Size -->
    <col class="shrink"><!-- Dim -->
    <col class="shrink"><!-- Codec -->
    <col class="shrink"><!-- Bitrate -->
    <col class="progress-col"><!-- Split -->
    <col class="progress-col"><!-- Encode -->
    <col class="progress-col"><!-- Stitch -->
    <col class="shrink"><!-- Started -->
    <col class="shrink"><!-- Elapsed -->
    <col class="shrink"><!-- Status -->
    <col class="shrink"><!-- Actions -->
  </colgroup>

  <thead>
    <tr class="bg-gray-200 text-xs">
      <th class="px-2 py-1 text-left">ID</th>
      <th class="px-2 py-1 text-left">Name</th>
      <th class="px-2 py-1 text-left">Size</th>
      <th class="px-2 py-1 text-left">Codec</th>
      <th class="px-2 py-1 text-center">Split</th>
      <th class="px-2 py-1 text-center">Encode</th>
      <th class="px-2 py-1 text-center">Stitch</th>
      <th class="px-2 py-1 text-left">Started</th>
      <th class="px-2 py-1 text-left">Time</th>
      <th class="px-2 py-1 text-left">Status</th>
      <th class="px-2 py-1 text-left">Actions</th>
    </tr>
  </thead>
  <tbody id="job-list"></tbody>
</table>

<div id="pagination" class="flex items-center justify-end gap-2 mt-3">
  <button id="pg-first" class="px-2 py-1 border rounded text-sm">« First</button>
  <button id="pg-prev"  class="px-2 py-1 border rounded text-sm">‹ Prev</button>
  <span id="pg-status"  class="text-sm text-gray-700 mx-2">Page 1 / 1</span>
  <button id="pg-next"  class="px-2 py-1 border rounded text-sm">Next ›</button>
  <button id="pg-last"  class="px-2 py-1 border rounded text-sm">Last »</button>
</div>

<!-- Toasts -->
<div id="toast-root" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

<!-- Properties Modal -->
<div id="properties-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded shadow-lg w-full max-w-2xl p-6 relative">
    <button onclick="closeModal('properties-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
      <span class="material-icons">close</span>
    </button>
    <h2 class="text-xl font-semibold mb-4">Job Properties</h2>
    <div id="properties-content" class="space-y-2 text-sm font-mono whitespace-pre-wrap"></div>
  </div>
</div>

<!-- Per-Job Settings Modal -->
<div id="job-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded shadow-lg w-full max-w-lg p-6 relative">
    <button onclick="closeModal('job-settings-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
      <span class="material-icons">close</span>
    </button>
    <h2 class="text-xl font-semibold mb-4">Job Settings</h2>

    <form id="job-settings-form" class="space-y-4" onsubmit="return false;">
      <input type="hidden" id="settings-job-id" value="">
      <div>
        <label class="block text-sm font-medium mb-1" for="settings-filename">Filename</label>
        <input id="settings-filename" type="text" class="border p-2 rounded w-full" disabled>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1" for="settings-segment-duration">Segment Length (s)</label>
          <input id="settings-segment-duration" type="number" min="1" max="300" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="settings-number-parts">Number of Parts</label>
          <input id="settings-number-parts" type="number" min="1" max="8" class="border p-2 rounded w-full">
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1" for="settings-v-stream">Video Stream</label>
          <select id="settings-v-stream" class="border p-2 rounded w-full"></select>
          <div class="text-xs text-gray-600 mt-1">Choose which video stream to encode.</div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="settings-a-stream">Audio Stream</label>
          <select id="settings-a-stream" class="border p-2 rounded w-full"></select>
          <div class="text-xs text-gray-600 mt-1">Choose which audio stream to encode.</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <input id="job-serialize-pipeline" type="checkbox" class="h-4 w-4">
        <label for="job-serialize-pipeline" class="text-sm">Serialize pipeline for this job</label>
      </div>
      <div class="flex gap-2 pt-2">
        <button id="save-job-settings-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hidden">Save</button>
        <button id="start-job-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">Start Job</button>
        <button type="button" class="ml-auto bg-gray-200 px-4 py-2 rounded hover:bg-gray-300" onclick="closeModal('job-settings-modal')">Close</button>
      </div>
      <div id="job-settings-help" class="text-xs text-gray-600"></div>
    </form>
  </div>
</div>

<!-- Video Preview Modal -->
<div id="video-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 items-center justify-center">
  <div class="bg-white rounded shadow-xl w-full max-w-5xl relative">
    <button onclick="closeVideoModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">
      <span class="material-icons">close</span>
    </button>

    <div class="p-4">
      <h3 id="video-title" class="text-lg font-semibold mb-2"></h3>
      <video id="video-player" class="w-full bg-black" controls playsinline></video>

      <div class="flex items-center gap-2 mt-3">
        <button id="btn-back-frame" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">
          <span class="material-icons align-middle">skip_previous</span> Frame -
        </button>
        <button id="btn-fwd-frame" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">
          Frame + <span class="material-icons align-middle">skip_next</span>
        </button>
        <div class="ml-auto text-xs text-gray-600">
          <span id="video-fps-label"></span>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // ---------- small helpers ----------
  const el = id => document.getElementById(id);
  const safeOn = (id, evt, handler) => { const n = el(id); if (n) n.addEventListener(evt, handler); };
  const shortHost = h => { if (!h) return ''; const m = String(h).match(/(\d+)/); return m ? m[1] : h; };
  const tsStr = ts => new Date(ts * 1000).toLocaleTimeString();
  const formatDateTime = ts => new Date(ts * 1000).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const formatBytes = b => { const n = Number(b); if (!n || n < 0) return '…'; const u=['B','KB','MB','GB','TB']; const i=Math.floor(Math.log(n)/Math.log(1024)); const v=n/Math.pow(1024,i); return `${v.toFixed(v>=10?0:1)} ${u[i]}`; };
  const formatKbps = v => { const n = parseFloat(v); if (!isFinite(n) || n<=0) return '…'; return Math.round(n).toLocaleString(); };
  const formatElapsed = secs => { const s = Number(secs||0); const m = Math.floor(s/60), r = Math.floor(s%60); return `${m}:${String(r).padStart(2,'0')}`; };
  const statusColorClass = (s='') => {
    s = String(s).toUpperCase();
    if (s==='READY') return 'text-gray-700';
    if (s==='STARTING'||s==='WAITING') return 'text-yellow-600';
    if (s==='RUNNING') return 'text-green-600';
    if (s==='STOPPED') return 'text-orange-600';
    if (s==='FAILED') return 'text-red-600';
    if (s==='DONE'||s==='COMPLETED') return 'text-blue-600';
    return 'text-gray-700';
  };
  function toast(message, ok=true) {
    const root = el('toast-root');
    const node = document.createElement('div');
    node.className = `px-3 py-2 rounded text-white shadow ${ok ? 'bg-green-600' : 'bg-red-600'}`;
    node.textContent = message;
    root.appendChild(node);
    setTimeout(()=>node.remove(), 2200);
  }
  const BLUE_FILL='rgba(37,99,235,0.85)', BLUE_STROKE='rgb(37,99,235)';
  const tinyBarOpts = (maxY=100)=>({
    type:'bar',
    data:{labels:[],datasets:[{data:[],backgroundColor:BLUE_FILL,borderColor:BLUE_STROKE,borderWidth:1}]},
    options:{
      responsive:true,maintainAspectRatio:false,animation:false,
      plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},
      scales:{
        x:{grid:{display:false},ticks:{autoSkip:false,maxRotation:0,minRotation:0,font:{size:10}}},
        y:{beginAtZero:true,suggestedMax:maxY,grid:{display:false},ticks:{stepSize:50,font:{size:10}}}
      }
    }
  });
  const gpuChart = new Chart(el('gpuChart').getContext('2d'), tinyBarOpts(100));
  const cpuChart = new Chart(el('cpuChart').getContext('2d'), tinyBarOpts(100));
  function updateBars(chart, labels, values, suggestedMax) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    if (suggestedMax !== undefined) chart.options.scales.y.suggestedMax = suggestedMax;
    chart.update('none');
  }
</script>

<!-- MINI NETWORK (shared cache) -->
<script>
  const MINI_WINDOW = 60;    // last 60 seconds
  const nowSec = ()=>Math.floor(Date.now()/1000);
  const mbps = bps => (Number(bps||0)*8/1e6);

  const PALETTE = [
    '#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd',
    '#8c564b','#e377c2','#17becf','#7f7f7f','#bcbd22',
    '#000000','#ff1493','#00ced1','#ffa500','#4169e1',
  ];
  const lighten = (hex,amt=0.38) => {
    const m = hex.match(/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i); if (!m) return hex;
    let [r,g,b]=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)];
    r=Math.round(r+(255-r)*amt); g=Math.round(g+(255-g)*amt); b=Math.round(b+(255-b)*amt);
    return '#' + [r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  };

  const netMiniChart = new Chart(el('netMiniChart').getContext('2d'), {
    type:'line',
    data:{ labels:[], datasets:[] },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{ display:false } },
      interaction:{ mode:'index', intersect:false },
      elements:{ point:{ radius:0 }},
      scales:{
        x:{ grid:{ display:false }, ticks:{ display:false } },
        y:{ beginAtZero:true, min:0, max:1000, ticks:{ stepSize:500, autoSkip:false, callback:v=>v.toLocaleString() } }
      }
    }
  });

  const hostOrder = [];
  const dsIndexByHost = {};
  function ensureHostDatasets(host){
    if (dsIndexByHost[host]) return;
    if (!hostOrder.includes(host)) hostOrder.push(host);
    const color = PALETTE[hostOrder.indexOf(host) % PALETTE.length];
    const rx = { label:`${host} RX`, data:[], borderColor:color, borderWidth:2, fill:false, tension:0.12, spanGaps:true };
    const tx = { label:`${host} TX`, data:[], borderColor:lighten(color,0.38), borderDash:[6,4], borderWidth:2, fill:false, tension:0.12, spanGaps:true };
    netMiniChart.data.datasets.push(rx); const rxIdx = netMiniChart.data.datasets.length-1;
    netMiniChart.data.datasets.push(tx); const txIdx = netMiniChart.data.datasets.length-1;
    dsIndexByHost[host] = { rx: rxIdx, tx: txIdx };
  }

  function renderMiniFromCache(cache){
    const start = Math.max(0, cache.labels.length - MINI_WINDOW);
    netMiniChart.data.labels = cache.labels.slice(start).map(()=> '');
    const hosts = Object.keys(cache.hosts).sort((a,b)=>{
      const na = parseInt((a||'').match(/\d+/)?.[0] || 0,10);
      const nb = parseInt((b||'').match(/\d+/)?.[0] || 0,10);
      return na - nb || a.localeCompare(b);
    });
    hosts.forEach(h=>{
      ensureHostDatasets(h);
      const idxs = dsIndexByHost[h];
      netMiniChart.data.datasets[idxs.rx].data = cache.hosts[h].rx.slice(start);
      netMiniChart.data.datasets[idxs.tx].data = cache.hosts[h].tx.slice(start);
    });
    netMiniChart.update('none');
  }

  async function fetchAndUpdateMiniNet(){
    try{
      const res = await fetch('/metrics_snapshot');
      if (!res.ok) return;
      const { nodes } = await res.json();
      const sample = {};
      (nodes||[]).forEach(n=>{
        const host = n.hostname; if (!host) return;
        sample[host] = { rx: mbps(n.rx_bps||0), tx: mbps(n.tx_bps||0) };
      });
      const cache = window.NETCACHE.push(nowSec(), sample);
      renderMiniFromCache(cache);
      const latestTs = cache.labels[cache.labels.length-1] || 0;
      el('net-updated').textContent = latestTs ? new Date(latestTs*1000).toLocaleTimeString() : '';
    }catch{}
  }

  // seed on load
  renderMiniFromCache(window.NETCACHE.load());
</script>

<!-- JOB LIST, PAGINATION & METRICS -->
<script>
  // ---- pager state ----
  const PAGER_KEY = 'thinvids_pager_v1';
  let CURRENT_PAGE = 1;
  const PAGE_SIZE = 10;
  let CURRENT_SORT = 'date';  // always date, per spec
  let CURRENT_DIR  = 'desc';
  let lastJobsReqId = 0;

  function loadPager(){
    try{
      const raw = localStorage.getItem(PAGER_KEY);
      if (!raw) return;
      const s = JSON.parse(raw);
      if (s && typeof s === 'object'){
        if (Number.isInteger(s.page) && s.page>0) CURRENT_PAGE = s.page;
        if (s.dir === 'asc' || s.dir === 'desc') CURRENT_DIR = s.dir;
      }
    }catch{}
  }
  function savePager(){
    try{ localStorage.setItem(PAGER_KEY, JSON.stringify({ page: CURRENT_PAGE, dir: CURRENT_DIR })); }catch{}
  }

  function applyPagerState(meta){
    const { page, total_pages } = meta;
    CURRENT_PAGE = page;
    savePager();
    const status = el('pg-status');
    if (status) status.textContent = `Page ${page} / ${total_pages}`;
    const f = el('pg-first'), p = el('pg-prev'), n = el('pg-next'), l = el('pg-last');
    if (f) f.disabled = page <= 1;
    if (p) p.disabled = page <= 1;
    if (n) n.disabled = page >= total_pages;
    if (l) l.disabled = page >= total_pages;
    window.__PAGER_META__ = meta;
  }

  // ---- nodes mini summaries (GPU/CPU) ----
  async function fetchMetrics(){
    try{
      const res = await fetch('/metrics_snapshot');
      if (!res.ok) return;
      const { nodes } = await res.json();
      nodes.sort((a,b)=>{
        const na=parseInt((a.hostname||'').match(/\d+/)?.[0]||0,10);
        const nb=parseInt((b.hostname||'').match(/\d+/)?.[0]||0,10);
        return na-nb;
      });
      const labels = nodes.map(n=>shortHost(n.hostname));
      const gpu = nodes.map(n => (n.gpu >= 0 ? Number(n.gpu.toFixed(1)) : 0));
      const cpu = nodes.map(n => Number((n.cpu||0).toFixed(1)));
      updateBars(gpuChart, labels, gpu, 100);
      updateBars(cpuChart, labels, cpu, 100);
      const latestTs = nodes.length ? Math.max(...nodes.map(n=>n.ts||0)) : 0;
      const stamp = latestTs ? tsStr(latestTs) : '';
      el('gpu-updated').textContent = stamp;
      el('cpu-updated').textContent = stamp;
    }catch{}
  }

  // ---- jobs table ----
  function progressBar(percent, elapsed){
    const p = Number(percent||0);
    return `
      <div class="relative prog-wrap h-4 bg-gray-200 rounded">
        <div class="absolute top-0 left-0 h-4 rounded bg-blue-500" style="width:${p}%"></div>
        <div class="absolute right-1 inset-0 text-right text-xs leading-4 font-medium text-black">${p}%</div>
        <div class="absolute left-1 inset-0 text-left text-xs leading-4 font-medium text-black">${formatElapsed(elapsed)}</div>
      </div>`;
  }

  async function fetchJobs(){
    const reqId = ++lastJobsReqId;
    const params = new URLSearchParams({
      page: String(CURRENT_PAGE),
      page_size: String(PAGE_SIZE),
      sort_by: 'date',
      sort_dir: CURRENT_DIR
    });
    const response = await fetch(`/jobs?${params.toString()}`);
    if (!response.ok) return;

    const payload = await response.json();
    const items = Array.isArray(payload) ? payload : (payload.items || []);
    const meta  = Array.isArray(payload)
      ? { page: CURRENT_PAGE, total_pages: 1, total: items.length, page_size: items.length }
      : { page: payload.page, total_pages: payload.total_pages, total: payload.total, page_size: payload.page_size };

    window.__JOBS_CACHE__ = items;

    const jobList = el('job-list');
    jobList.innerHTML = '';

    items.forEach(job=>{
      const row = document.createElement('tr');

      const idShort = (job.job_id||'').split('-')[0] || '';
      const baseName = (job.filename||'').split('/').pop() || '';
      const displayName = baseName.replace(/\.[^.]+$/,'') || baseName || 'N/A';
      const nameColor = statusColorClass(job.status||'');

      const canStart   = job.status === 'READY';
      const canStop    = (job.status === 'STARTING' || job.status === 'WAITING' || job.status === 'RUNNING');
      const canRestart = (job.status === 'STOPPED' || job.status === 'FAILED' || job.status === 'DONE');

      const vcrBtnHtml = canStart
        ? `<button class="vcr-start-btn" title="Start"><span class="material-icons text-green-600 hover:text-green-800">play_circle</span></button>`
        : (canStop
            ? `<button class="vcr-stop-btn" title="Stop"><span class="material-icons text-orange-600 hover:text-orange-800">stop_circle</span></button>`
            : (canRestart
                ? `<button class="vcr-restart-btn" title="Restart"><span class="material-icons text-orange-600 hover:text-orange-800">change_circle</span></button>`
                : ''));

      const isDone = String(job.status||'').toUpperCase()==='DONE';
      const nameInner = isDone
        ? `<button class="name-text font-bold underline ${nameColor} hover:opacity-80 name-preview"
             title="Preview"
             data-title="${displayName.replace(/"/g,'&quot;')}"
             data-jobid="${job.job_id}"
             data-fps="${Number(job.source_fps||0)}">${displayName}</button>`
        : `<span class="name-text font-bold ${nameColor}">${displayName}</span>`;

      const nameCellHTML =
        `<div class="name-clip" title="${displayName.replace(/"/g,'&quot;')}">${nameInner}</div>`;

      const srcKbps = (() => {
        const kbpsStored = parseFloat(job.source_bitrate_kbps);
        if (isFinite(kbpsStored) && kbpsStored>0) return kbpsStored;
        const sz = Number(job.source_file_size||0);
        const dur = parseFloat(job.source_duration||0);
        return (sz>0 && isFinite(dur) && dur>0) ? (sz*8)/dur/1000 : NaN;
      })();

      row.innerHTML = `
        <td class="px-2 py-1">${idShort}</td>
        <td class="px-2 py-1 name-cell">${nameCellHTML}</td>
        <td class="px-2 py-1">${formatBytes(job.source_file_size)}</td>
        <td class="px-2 py-1">${job.source_codec || '…'}</td>
        <td class="px-2 py-1 text-center"><div class="w-28 mx-auto">${progressBar(job.segment_progress||0, job.segment_elapsed||0)}</div></td>
        <td class="px-2 py-1 text-center"><div class="w-28 mx-auto">${progressBar(job.encode_progress||0, job.encode_elapsed||0)}</div></td>
        <td class="px-2 py-1 text-center"><div class="w-28 mx-auto">${progressBar(job.combine_progress||0, job.combine_elapsed||0)}</div></td>
        <td class="px-2 py-1">${formatDateTime(job.started)}</td>
        <td class="px-2 py-1">${formatElapsed(job.elapsed)}</td>
        <td class="px-2 py-1"><span class="font-medium ${nameColor}">${job.status || 'READY'}</span></td>
        <td class="px-2 py-1">
          <div class="flex items-center justify-center gap-1">
            ${job.filename && job.filename !== 'undefined'
              ? `<button class="copy-btn" title="Copy"><span class="material-icons text-blue-600 hover:text-blue-800">content_copy</span></button>` : ''}
            <button class="delete-btn" title="Delete"><span class="material-icons text-red-600 hover:text-red-800">delete</span></button>
            <button class="properties-btn" title="Properties"><span class="material-icons text-gray-700 hover:text-black">info</span></button>
            <button class="settings-btn" title="Settings"><span class="material-icons text-gray-700 hover:text-black">settings</span></button>
            ${vcrBtnHtml}
          </div>
        </td>
      `;
      jobList.appendChild(row);

      const previewBtn = row.querySelector('.name-preview');
      if (previewBtn){
        previewBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          const title = previewBtn.dataset.title || displayName;
          const jobId = previewBtn.dataset.jobid;
          const fps   = Number(previewBtn.dataset.fps || job.source_fps || 0);
          if (jobId) openVideoModal(title, jobId, fps);
        });
      }
      const copyBtn = row.querySelector('.copy-btn');
      if (copyBtn) copyBtn.addEventListener('click', async ()=>{
        try{
          const r = await fetch('/copy_job', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ job_id: job.job_id })});
          const j = await r.json();
          if (r.ok && j.status==='success') { toast(`Copied job ${job.job_id.split('-')[0]} → ${j.job_id.split('-')[0]} (PAUSED)`); fetchJobs(); }
          else throw new Error(j.message || 'Copy failed');
        }catch(err){ toast(`Copy failed: ${err.message}`, false); }
      });
      row.querySelector('.delete-btn').addEventListener('click', async ()=>{
        if (!confirm('Delete this job?')) return;
        const r = await fetch(`/delete_job/${job.job_id}`, { method:'DELETE' });
        if (r.ok) fetchJobs(); else alert('Failed to delete job');
      });
      row.querySelector('.properties-btn').addEventListener('click', async ()=>{ await showProperties(job.job_id); });
      row.querySelector('.settings-btn').addEventListener('click', async ()=>{ await showJobSettings(job.job_id); });
      row.querySelector('.vcr-start-btn')?.addEventListener('click', async ()=>{ const r=await fetch(`/start_job/${job.job_id}`,{method:'POST'}); if (r.ok) fetchJobs(); });
      row.querySelector('.vcr-stop-btn')?.addEventListener('click',  async ()=>{ if(!confirm('Stop this job?'))return; const r=await fetch(`/stop_job/${job.job_id}`,{method:'POST'}); if (r.ok) fetchJobs(); });
      row.querySelector('.vcr-restart-btn')?.addEventListener('click',async ()=>{ const r=await fetch(`/restart_job/${job.job_id}`,{method:'POST'}); if (r.ok) fetchJobs(); });
    });

    applyPagerState(meta);
  }

  // ------- Job properties & settings modals -------
  async function showProperties(job_id){
    const res = await fetch(`/job_properties/${job_id}`);
    if (!res.ok) return alert('Failed to load properties');
    const data = await res.json();
    el('properties-content').innerText = JSON.stringify(data, null, 2);
    el('properties-modal').classList.remove('hidden');
  }
  function closeModal(id){ el(id)?.classList.add('hidden'); }

  async function showJobSettings(job_id){
    const res = await fetch(`/job_settings/${job_id}`);
    if (!res.ok) return alert('Failed to load settings');
    const data = await res.json();
    const editable = ['READY','STOPPED','FAILED'].includes(String(data.status||'').toUpperCase());
    el('settings-job-id').value = job_id;
    el('settings-filename').value = data.filename || '';
    el('settings-segment-duration').value = data.segment_duration || 10;
    el('settings-number-parts').value = data.number_parts || 2;
    const vSel = el('settings-v-stream'), aSel = el('settings-a-stream');
    vSel.innerHTML = ''; aSel.innerHTML = '';
    const raw = data.streams;
    const streams = typeof raw === 'string' ? (JSON.parse(raw)||{video:[],audio:[]}) : (raw||{video:[],audio:[]});
    (streams.video||[]).forEach((v,idx)=>{
      const label = [`#${idx}`, v.codec||'', (v.width&&v.height)?`${v.width}x${v.height}`:'', v.fps?`${Number(v.fps).toFixed(2)}fps`:'', v.title?`“${v.title}”`:''].filter(Boolean).join(' · ');
      const o = document.createElement('option'); o.value=String(idx); o.textContent=label; vSel.appendChild(o);
    });
    (streams.audio||[]).forEach((a,idx)=>{
      const label = [`#${idx}`, a.codec||'', a.channel_layout||(a.channels?`${a.channels}ch`:''), a.language||'', a.title?`“${a.title}”`:'', a.disposition_default?'(default)':''].filter(Boolean).join(' · ');
      const o = document.createElement('option'); o.value=String(idx); o.textContent=label; aSel.appendChild(o);
    });
    const setSelectIndexByValue = (sel,val,fallback=0)=>{ if(!sel||!sel.options.length)return; let i=parseInt(val,10); if(Number.isNaN(i)) i=fallback; if(i<0||i>=sel.options.length) i=fallback; sel.selectedIndex=i; };
    setSelectIndexByValue(vSel, data.selected_v_stream, 0);
    setSelectIndexByValue(aSel, data.selected_a_stream, 0);
    el('settings-segment-duration').disabled = !editable;
    el('settings-number-parts').disabled = !editable;
    vSel.disabled = !editable; aSel.disabled = !editable;
    el('save-job-settings-btn').classList.toggle('hidden', !editable);
    el('start-job-btn').classList.toggle('hidden', !(String(data.status).toUpperCase()==='READY'));
    el('job-settings-help').innerHTML = editable
      ? 'You can adjust settings before starting (READY) or before restarting (STOPPED/FAILED).'
      : 'This job is active or finished. Settings are read-only.';
    el('save-job-settings-btn').onclick = saveJobSettings;
    el('start-job-btn').onclick = ()=>startJob(job_id);
    el('job-settings-modal').classList.remove('hidden');
  }

  async function saveJobSettings(){
    const job_id = el('settings-job-id').value;
    const segment_duration = parseInt(el('settings-segment-duration').value,10);
    const number_parts     = parseInt(el('settings-number-parts').value,10);
    const selected_v_stream= el('settings-v-stream').selectedIndex;
    const selected_a_stream= el('settings-a-stream').selectedIndex;
    const serialize_pipeline = el('job-serialize-pipeline').checked;
    const res = await fetch(`/job_settings/${job_id}`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ segment_duration, number_parts, selected_v_stream, selected_a_stream, serialize_pipeline })
    });
    if (res.ok){ closeModal('job-settings-modal'); fetchJobs(); }
    else { alert((await res.text())||'Failed to save settings'); }
  }

  // ---- video modal helpers ----
  function openVideoModal(title, jobId, fps){
    const player = el('video-player'), label = el('video-fps-label'), titleEl = el('video-title');
    const _fps = (Number(fps)>0)?Number(fps):30;
    titleEl.textContent = String(title||'');
    label.textContent   = `FPS: ${_fps.toFixed(2)}`;
    player.pause(); player.removeAttribute('src'); player.load();
    player.src = `/preview/${encodeURIComponent(jobId)}`; player.currentTime=0; player.load();
    const modal = el('video-modal'); modal.classList.remove('hidden'); modal.classList.add('flex');
    player.play().catch(()=>{}); player.focus();
  }
  function closeVideoModal(){
    const modal = el('video-modal'); const player = el('video-player');
    player.pause(); player.removeAttribute('src'); player.load();
    modal.classList.add('hidden'); modal.classList.remove('flex');
  }
  function stepFrame(delta){
    const player = el('video-player'); if(!player) return;
    const fpsText = (el('video-fps-label').textContent||'').match(/([\d.]+)/);
    const fps = fpsText ? Number(fpsText[1]) : 30;
    const step = 1/(fps||30);
    player.pause(); player.currentTime = Math.max(0, player.currentTime + delta*step);
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    safeOn('btn-back-frame','click',()=>stepFrame(-1));
    safeOn('btn-fwd-frame','click', ()=>stepFrame(1));

    // restore pager
    loadPager();

    safeOn('pg-first','click',()=>{ CURRENT_PAGE = 1; savePager(); fetchJobs(); });
    safeOn('pg-prev','click', ()=>{ CURRENT_PAGE = Math.max(1, CURRENT_PAGE-1); savePager(); fetchJobs(); });
    safeOn('pg-next','click', ()=>{ const meta = window.__PAGER_META__ || { total_pages: CURRENT_PAGE }; CURRENT_PAGE = Math.min(meta.total_pages, CURRENT_PAGE+1); savePager(); fetchJobs(); });
    safeOn('pg-last','click', ()=>{ const meta = window.__PAGER_META__ || { total_pages: CURRENT_PAGE }; CURRENT_PAGE = meta.total_pages; savePager(); fetchJobs(); });

    // initial pulls
    fetchJobs();
    fetchMetrics();
    fetchAndUpdateMiniNet();

    // timers
    setInterval(fetchJobs, 1000);
    setInterval(fetchMetrics, 1000);
    setInterval(fetchAndUpdateMiniNet, 1000);
  });
</script>
{% endblock %}
