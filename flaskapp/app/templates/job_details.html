<!DOCTYPE html>
<html>
<head>
  <title>Job Details - Video Encoding Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    .progress-bar {
      width: 120px;
    }
    .elapsed-time {
      font-size: 0.75rem;
      color: #4B5563;
      text-align: center;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body class="bg-gray-100">

{% macro elapsed(seconds) %}
  {% set mins = (seconds // 60)|int %}
  {% set secs = (seconds % 60)|int %}
  {{ mins }}m {{ secs }}s
{% endmacro %}

<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Job Details for Job ID: {{ job_id }}</h1>
  <a href="/" class="text-blue-500 hover:underline mb-4 inline-block">Back to Jobs</a>
  
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Job Information</h2>
    <div class="grid grid-cols-2 gap-4">
      <div><strong>Filename:</strong> {{ job_data.filename }}</div>
      <div><strong>Status:</strong> 
        {% if job_data.status == 'FAILED' and job_data.log_path %}
          <a href="/log/{{ job_id }}" class="font-medium text-red-600 underline">FAILED</a>
        {% elif job_data.status == 'ABORTED' and job_data.job_dir %}
          <a href="/job_files/{{ job_id }}" class="font-medium text-orange-600 underline">ABORTED</a>
        {% else %}
          <span class="font-medium 
            {% if job_data.status == 'COMPLETED' %}text-green-600
            {% elif job_data.status == 'FAILED' %}text-red-600
            {% elif job_data.status == 'ABORTED' %}text-orange-600
            {% else %}text-yellow-600{% endif %}">{{ job_data.status }}</span>
        {% endif %}
      </div>
      <div><strong>Started:</strong> {{ elapsed(job_data.started_at|float) }}</div>
      <div><strong>Elapsed:</strong> {{ elapsed(job_data.elapsed|float) }}</div>
      <div><strong>Split Progress:</strong> 
        <div class="progress-bar">
          <div class="relative w-full h-4 bg-gray-200 rounded">
            <div class="absolute top-0 left-0 h-4 bg-blue-500 rounded" style="width: {{ job_data.segment_progress|default(0) }}%"></div>
            <div class="absolute w-full text-center text-xs leading-4 font-medium text-black">{{ job_data.segment_progress|default(0) }}%</div>
          </div>
          <div class="elapsed-time">{{ elapsed(job_data.segment_elapsed|float) }}</div>
        </div>
      </div>
      <div><strong>Encode Progress:</strong> 
        <div class="progress-bar">
          <div class="relative w-full h-4 bg-gray-200 rounded">
            <div class="absolute top-0 left-0 h-4 bg-blue-500 rounded" style="width: {{ job_data.encode_progress|default(0) }}%"></div>
            <div class="absolute w-full text-center text-xs leading-4 font-medium text-black">{{ job_data.encode_progress|default(0) }}%</div>
          </div>
          <div class="elapsed-time">{{ elapsed(job_data.encode_elapsed|float) }}</div>
        </div>
      </div>
      <div><strong>Stitch Progress:</strong> 
        <div class="progress-bar">
          <div class="relative w-full h-4 bg-gray-200 rounded">
            <div class="absolute top-0 left-0 h-4 bg-blue-500 rounded" style="width: {{ job_data.combine_progress|default(0) }}%"></div>
            <div class="absolute w-full text-center text-xs leading-4 font-medium text-black">{{ job_data.combine_progress|default(0) }}%</div>
          </div>
          <div class="elapsed-time">{{ elapsed(job_data.combine_elapsed|float) }}</div>
        </div>
      </div>
      {% if job_data.output_path %}
      <div><strong>Output Path:</strong> {{ job_data.output_path }}</div>
      {% endif %}
    </div>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">Resource Usage by Host</h2>
    <canvas id="resourceChart" height="100"></canvas>
  </div>
</div>

<script>
  // Prepare data for Chart.js
  const metricsByHost = {{ metrics_by_host | tojson }};

  // Get unique timestamps across all hosts for the x-axis
  const allTimestamps = new Set();
  Object.values(metricsByHost).forEach(metrics => {
    metrics.forEach(m => allTimestamps.add(m.timestamp));
  });
  const labels = Array.from(allTimestamps)
    .sort((a, b) => a - b)
    .map(ts => new Date(ts * 1000).toLocaleTimeString());

  // Define color palette for hosts
  const colorPalette = [
    'rgba(75, 192, 192, 1)',  // Teal
    'rgba(255, 99, 132, 1)',  // Red
    'rgba(54, 162, 235, 1)',  // Blue
    'rgba(255, 206, 86, 1)',  // Yellow
    'rgba(153, 102, 255, 1)', // Purple
    'rgba(255, 159, 64, 1)'   // Orange
  ];

  // Create datasets for CPU and Memory per host
  const cpuDatasets = [];
  const memoryDatasets = [];
  let colorIndex = 0;

  Object.keys(metricsByHost).forEach(host => {
    const metrics = metricsByHost[host].sort((a, b) => a.timestamp - b.timestamp);
    const color = colorPalette[colorIndex % colorPalette.length];
    const fadedColor = color.replace('1)', '0.2)');

    // CPU dataset
    cpuDatasets.push({
      label: `CPU Usage (%) - ${host}`,
      data: labels.map(label => {
        const timestamp = new Date(label).getTime() / 1000;
        const metric = metrics.find(m => new Date(m.timestamp * 1000).toLocaleTimeString() === label);
        return metric ? metric.cpu_percent : null;
      }),
      borderColor: color,
      backgroundColor: fadedColor,
      fill: false,
      yAxisID: 'y-cpu',
      spanGaps: true
    });

    // Memory dataset
    memoryDatasets.push({
      label: `Memory Usage (MB) - ${host}`,
      data: labels.map(label => {
        const timestamp = new Date(label).getTime() / 1000;
        const metric = metrics.find(m => new Date(m.timestamp * 1000).toLocaleTimeString() === label);
        return metric ? metric.memory_mb : null;
      }),
      borderColor: color,
      backgroundColor: fadedColor,
      fill: false,
      yAxisID: 'y-memory',
      spanGaps: true
    });

    colorIndex++;
  });

  const ctx = document.getElementById('resourceChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [...cpuDatasets, ...memoryDatasets]
    },
    options: {
      scales: {
        x: {
          title: { display: true, text: 'Time' }
        },
        'y-cpu': {
          type: 'linear',
          display: true,
          position: 'left',
          title: { display: true, text: 'CPU Usage (%)' },
          suggestedMin: 0,
          suggestedMax: 100
        },
        'y-memory': {
          type: 'linear',
          display: true,
          position: 'right',
          title: { display: true, text: 'Memory Usage (MB)' },
          suggestedMin: 0
        }
      },
      plugins: {
        legend: { display: true }
      }
    }
  });

  {% if job_data.status not in ['COMPLETED', 'FAILED', 'ABORTED'] %}
  setInterval(async () => {
    const response = await fetch('/job_details/{{ job_id }}');
    const html = await response.text();
    document.body.innerHTML = html;
  }, 5000);
  {% endif %}
</script>
</body>
</html>