<!DOCTYPE html>
<html>
<head>
  <title>Video Encoding Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Video Encoding Manager</h1>
      <div class="flex items-center gap-2">
        <label for="sort-by" class="text-sm text-gray-700">Sort by:</label>
        <select id="sort-by" class="border rounded px-2 py-1 text-sm">
          <option value="date" selected>Date</option>
          <option value="filename">Filename</option>
          <option value="status">Status</option>
          <option value="encode">Encode %</option>
        </select>
        <button id="open-global-settings" class="flex items-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">
          <span class="material-icons">settings</span>
          Global Settings
        </button>
      </div>
    </div>

    <h2 class="text-xl font-semibold mb-2">Current Jobs</h2>

    <table id="job-table" class="w-full border-collapse bg-white">
      <thead>
        <tr class="bg-gray-200">
          <th class="px-2 py-1 text-left">ID</th>
          <th class="px-2 py-1 text-left">Name</th>
          <th class="px-2 py-1 text-left">Size</th>
          <th class="px-2 py-1 text-left">Dim</th>
          <th class="px-2 py-1 text-left">Dur</th>
          <th class="px-2 py-1 text-left">Codec</th>
          <th class="px-2 py-1 text-left">FPS</th>
          <th class="px-2 py-1 text-center">Split</th>
          <th class="px-2 py-1 text-center">Encode</th>
          <th class="px-2 py-1 text-center">Stitch</th>
          <th class="px-2 py-1 text-left">Started</th>
          <th class="px-2 py-1 text-left">Elapsed</th>
          <th class="px-2 py-1 text-left">Status</th>
          <th class="px-2 py-1 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="job-list"></tbody>
    </table>
  </div>

  <!-- Toast container -->
  <div id="toast-root" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <!-- Properties Modal -->
  <div id="properties-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg w-full max-w-2xl p-6 relative">
      <button onclick="closeModal('properties-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
        <span class="material-icons">close</span>
      </button>
      <h2 class="text-xl font-semibold mb-4">Job Properties</h2>
      <div id="properties-content" class="space-y-2 text-sm font-mono whitespace-pre-wrap"></div>
    </div>
  </div>

  <!-- Per-Job Settings Modal -->
  <div id="job-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg w-full max-w-lg p-6 relative">
      <button onclick="closeModal('job-settings-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
        <span class="material-icons">close</span>
      </button>
      <h2 class="text-xl font-semibold mb-4">Job Settings</h2>

      <form id="job-settings-form" class="space-y-4" onsubmit="return false;">
        <input type="hidden" id="settings-job-id" value="">
        <div>
          <label class="block text-sm font-medium mb-1" for="settings-filename">Filename</label>
          <input id="settings-filename" type="text" class="border p-2 rounded w-full" disabled>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="settings-segment-duration">Segment Length (s)</label>
            <input id="settings-segment-duration" type="number" min="1" max="300" class="border p-2 rounded w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="settings-number-parts">Number of Parts</label>
            <input id="settings-number-parts" type="number" min="1" max="8" class="border p-2 rounded w-full">
          </div>
        </div>

        <div class="flex gap-2 pt-2">
          <button id="save-job-settings-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hidden">Save</button>
          <button id="start-job-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">Start Job</button>
          <button type="button" class="ml-auto bg-gray-200 px-4 py-2 rounded hover:bg-gray-300" onclick="closeModal('job-settings-modal')">Close</button>
        </div>
        <div id="job-settings-help" class="text-xs text-gray-600"></div>
      </form>
    </div>
  </div>

  <!-- Global Settings Modal -->
  <div id="global-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg w-full max-w-lg p-6 relative">
      <button onclick="closeModal('global-settings-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
        <span class="material-icons">close</span>
      </button>
      <h2 class="text-xl font-semibold mb-4">Global Settings</h2>
      <form id="global-settings-form" class="space-y-4" onsubmit="return false;">
        <div>
          <label class="block text-sm font-medium mb-1" for="global-segment-duration">Segment Length (seconds)</label>
          <input id="global-segment-duration" type="number" min="1" max="300" class="border p-2 rounded w-full">
          <div class="text-xs text-gray-600 mt-1">Enter 1–300 seconds. Default is 10.</div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="global-number-parts">Number of Parts</label>
          <input id="global-number-parts" type="number" min="1" max="8" class="border p-2 rounded w-full">
          <div class="text-xs text-gray-600 mt-1">Split the video into 1–8 parts. Default is 2.</div>
        </div>
        <div class="flex items-center gap-2">
          <input id="global-auto-start" type="checkbox" class="h-4 w-4">
          <label for="global-auto-start" class="text-sm">Automatically start encode jobs</label>
        </div>
        <div class="flex gap-2 pt-2">
          <button id="save-global-settings-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
          <button type="button" class="ml-auto bg-gray-200 px-4 py-2 rounded hover:bg-gray-300" onclick="closeModal('global-settings-modal')">Close</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------- Utils ----------
    function statusColorClass(status = '') {
      const s = String(status || '').toUpperCase();
      // New unified states
      if (s === 'READY') return 'text-yellow-600';
      if (s === 'RUNNING') return 'text-blue-600';
      if (s === 'STOPPED') return 'text-gray-600';
      if (s === 'FAILED') return 'text-red-600';
      if (s === 'DONE' || s === 'COMPLETED') return 'text-green-600';

      // Legacy / transitional states (fallbacks)
      if (s.startsWith('SEG') || s.startsWith('ENC') || s.includes('STITCH')) return 'text-blue-600';
      if (s === 'ABORTED') return 'text-gray-600';
      if (s === 'QUEUED' || s === 'PAUSED') return 'text-yellow-600';
      return 'text-black';
    }

    function prettyTitleFromPath(path = '') {
      const base = (path.split('/').pop() || '').replace(/\.[^.]+$/, '').trim();

      // TV: "Show - S01E03 - Episode Title"  => "Show - S01E03"
      //     "Show - 1x03 - Episode Title"    => "Show - 1x03"
      //     "Show - 2023-05-01 - Title"      => "Show - 2023-05-01"
      const tvMatch = base.match(/^(.+?)\s*-\s*([^-\n]+)\s*-\s*.*$/);
      if (tvMatch) {
        const show = tvMatch[1].trim();
        const ep   = tvMatch[2].trim();
        return `${show} - ${ep}`;
      }

      // Movie: "Name [2021, PG-13, ...]" => "Name"
      const movieMatch = base.match(/^(.+?)\s*\[\s*\d{4}.*\]$/);
      if (movieMatch) return movieMatch[1].trim();

      return base || path.split('/').pop() || 'N/A';
    }
    function toast(message, ok = true) {
      const root = document.getElementById('toast-root');
      const el = document.createElement('div');
      el.className = `px-3 py-2 rounded text-white shadow ${ok ? 'bg-green-600' : 'bg-red-600'}`;
      el.textContent = message;
      root.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function formatElapsed(seconds) {
      if (seconds == null || isNaN(seconds)) return '';
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${String(s).padStart(2, '0')}`;
    }
    function formatDateTime(timestamp) {
      if (!timestamp || isNaN(timestamp)) return '';
      const dt = new Date(timestamp * 1000);
      return dt.toLocaleString();
    }
    function formatBytes(bytes) {
      const b = Number(bytes);
      if (!b || b < 0) return '…';
      const units = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(b) / Math.log(1024));
      const v = b / Math.pow(1024, i);
      return `${v.toFixed(v >= 10 ? 0 : 1)} ${units[i]}`;
    }
    function formatDurationSeconds(secStr) {
      const s = parseFloat(secStr);
      if (!isFinite(s) || s <= 0) return '…';
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const s2 = Math.floor(s % 60);
      return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(s2).padStart(2,'0')}`
                   : `${m}:${String(s2).padStart(2,'0')}`;
    }
    function formatFPS(val) {
      const n = parseFloat(val);
      if (!isFinite(n) || n <= 0) return '…';
      return n.toFixed(n >= 100 ? 0 : 2);
    }
    function progressBar(percent) {
      percent = Number(percent || 0);
      return `
        <div class="relative w-full h-4 bg-gray-200 rounded">
          <div class="absolute top-0 left-0 h-4 rounded bg-blue-500" style="width: ${percent}%"></div>
          <div class="absolute inset-0 text-center text-xs leading-4 font-medium text-black">${percent}%</div>
        </div>
      `;
    }
    // ---------- Global Settings ----------
    async function showGlobalSettings() {
      const res = await fetch('/global_settings');
      if (!res.ok) return alert('Failed to load global settings');
      const data = await res.json();
      document.getElementById('global-segment-duration').value = data.segment_duration ?? 10;
      document.getElementById('global-number-parts').value = data.number_parts ?? 2;
      document.getElementById('global-auto-start').checked = !!data.auto_start;
      document.getElementById('global-settings-modal').classList.remove('hidden');
    }
    async function saveGlobalSettings() {
      const segment_duration = parseInt(document.getElementById('global-segment-duration').value, 10);
      const number_parts = parseInt(document.getElementById('global-number-parts').value, 10);
      const auto_start = document.getElementById('global-auto-start').checked;

      const res = await fetch('/global_settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ segment_duration, number_parts, auto_start })
      });
      if (res.ok) {
        toast('Saved global settings', true);
        closeModal('global-settings-modal');
      } else {
        const msg = await res.text();
        toast(msg || 'Failed to save global settings', false);
      }
    }
    document.getElementById('open-global-settings').addEventListener('click', showGlobalSettings);
    document.getElementById('save-global-settings-btn').addEventListener('click', saveGlobalSettings);

    // ---------- Job Info / Properties ----------
    async function showProperties(job_id) {
      const res = await fetch(`/job_properties/${job_id}`);
      if (!res.ok) return alert('Failed to load properties');
      const data = await res.json();
      document.getElementById('properties-content').innerText = JSON.stringify(data, null, 2);
      document.getElementById('properties-modal').classList.remove('hidden');
    }

    // ---------- Per-Job Settings ----------
    async function showJobSettings(job_id) {
      const res = await fetch(`/job_settings/${job_id}`);
      if (!res.ok) return alert('Failed to load settings');
      const data = await res.json();
      const paused = (data.status === 'PAUSED');

      document.getElementById('settings-job-id').value = job_id;
      document.getElementById('settings-filename').value = data.filename || '';
      document.getElementById('settings-segment-duration').value = data.segment_duration || 10;
      document.getElementById('settings-number-parts').value = data.number_parts || 2;

      document.getElementById('settings-segment-duration').disabled = !paused;
      document.getElementById('settings-number-parts').disabled = !paused;

      document.getElementById('save-job-settings-btn').classList.toggle('hidden', !paused);
      document.getElementById('start-job-btn').classList.toggle('hidden', !paused);

      document.getElementById('job-settings-help').innerHTML = paused
        ? 'This job is <strong>PAUSED</strong>. You can change settings and then start the job.'
        : 'This job is active or finished. Settings are read-only.';

      document.getElementById('save-job-settings-btn').onclick = saveJobSettings;
      document.getElementById('start-job-btn').onclick = () => startJob(job_id);

      document.getElementById('job-settings-modal').classList.remove('hidden');
    }

    async function saveJobSettings() {
      const job_id = document.getElementById('settings-job-id').value;
      const segment_duration = parseInt(document.getElementById('settings-segment-duration').value, 10);
      const number_parts = parseInt(document.getElementById('settings-number-parts').value, 10);

      const res = await fetch(`/job_settings/${job_id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ segment_duration, number_parts })
      });
      if (res.ok) {
        closeModal('job-settings-modal');
        fetchJobs();
      } else {
        const msg = await res.text();
        alert(msg || 'Failed to save settings');
      }
    }

    // ---------- Jobs CRUD ----------
    async function copyJob(job_id) {
      try {
        const response = await fetch('/copy_job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id })
        });
        const result = await response.json();
        if (response.ok && result.status === 'success') {
          toast(`Copied job ${job_id.split('-')[0]} → ${result.job_id.split('-')[0]} (PAUSED)`, true);
          fetchJobs();
        } else {
          throw new Error(result.message || 'Failed to copy job');
        }
      } catch (err) {
        toast(`Copy failed: ${err.message}`, false);
      }
    }

    async function deleteJob(job_id) {
      if (!confirm('Delete this job?')) return;
      const response = await fetch(`/delete_job/${job_id}`, { method: 'DELETE' });
      if (response.ok) fetchJobs(); else alert('Failed to delete job');
    }

    async function stopJob(job_id) {
      if (!confirm('Stop this job? This will abort all tasks but keep the project directory.')) return;
      const response = await fetch(`/stop_job/${job_id}`, { method: 'POST' });
      if (response.ok) fetchJobs(); else alert('Failed to stop job');
    }

    async function startJob(job_id) {
      const response = await fetch(`/start_job/${job_id}`, { method: 'POST' });
      if (response.ok) fetchJobs(); else alert('Failed to start job');
    }

    async function restartJob(job_id) {
      const response = await fetch(`/restart_job/${job_id}`, { method: 'POST' });
      if (response.ok) fetchJobs(); else alert('Failed to restart job');
    }

    // ---------- Sorting ----------
    let CURRENT_SORT = 'date'; // default

    function statusRank(s) {
      const order = {
        'READY': 0,
        'RUNNING': 1,
        'STOPPED': 2,
        'FAILED': 3,
        'DONE': 4
      };
      return order[s] ?? 99;
    }

    function compareJobs(a, b) {
      switch (CURRENT_SORT) {
        case 'filename': {
          const af = (a.filename || '').toLowerCase();
          const bf = (b.filename || '').toLowerCase();
          if (af < bf) return -1;
          if (af > bf) return 1;
          return 0;
        }
        case 'status': {
          const ar = statusRank(a.status || '');
          const br = statusRank(b.status || '');
          if (ar !== br) return ar - br;
          const af = (a.filename || '').toLowerCase();
          const bf = (b.filename || '').toLowerCase();
          if (af < bf) return -1;
          if (af > bf) return 1;
          return 0;
        }
        case 'encode': {
          const ae = Number(a.encode_progress || 0);
          const be = Number(b.encode_progress || 0);
          if (ae !== be) return be - ae;
          if (a.started !== b.started) return b.started - a.started;
          const af = (a.filename || '').toLowerCase();
          const bf = (b.filename || '').toLowerCase();
          if (af < bf) return -1;
          if (af > bf) return 1;
          return 0;
        }
        case 'date':
        default: {
          const aPaused = Number(a.started || 0) === 0;
          const bPaused = Number(b.started || 0) === 0;
          if (aPaused && bPaused) {
            return Number(b.created || 0) - Number(a.created || 0);
          }
          if (aPaused && !bPaused) return -1;
          if (!aPaused && bPaused) return 1;
          return Number(b.started || 0) - Number(a.started || 0);
        }
      }
    }

    document.getElementById('sort-by').addEventListener('change', (e) => {
      CURRENT_SORT = e.target.value || 'date';
      fetchJobs(true); // re-render using cache
    });

    // ---------- Table render ----------
    async function fetchJobs(skipFetch = false) {
      let jobs;
      if (!skipFetch) {
        const response = await fetch('/jobs');
        jobs = await response.json();
        window.__JOBS_CACHE__ = jobs;
      } else {
        jobs = window.__JOBS_CACHE__ || [];
      }

      jobs = jobs.slice().sort(compareJobs);

      const jobList = document.getElementById('job-list');
      jobList.innerHTML = '';

      jobs.forEach(job => {
        const row = document.createElement('tr');

        const idShort = (job.job_id || '').split('-')[0] || '';
        const displayName = prettyTitleFromPath(job.filename || '');
        const nameColor = statusColorClass(job.status || '');
        
        // metadata (placeholder-friendly)
        const sizeDisp = formatBytes(job.source_file_size);
        const dimDisp = job.source_resolution || '…';
        const durDisp = formatDurationSeconds(job.source_duration);
        const codecDisp = job.source_codec || '…';
        const fpsDisp = formatFPS(job.source_fps);

        const isTerminal = (job.status === 'FAILED'); // no completed state now
        const canStart   = job.status === 'READY';
        const canStop    = job.status === 'RUNNING';
        const canRestart = (job.status === 'STOPPED' || job.status === 'FAILED');

        const totalChunks = Number(job.total_chunks || 0);
        const segCount    = Number(job.segmented_chunks || 0);
        const encCount    = Number(job.completed_chunks || 0);
        // For stitch, we approximate based on progress (ffmpeg concat doesn’t emit file index)
        const stitchedApprox = totalChunks > 0 ? Math.floor((Number(job.combine_progress || 0) / 100) * totalChunks) : 0;

        const vcrBtnHtml = canStart
          ? `<button class="vcr-start-btn" title="Start"><span class="material-icons text-green-600 hover:text-green-800">play_circle</span></button>`
          : (canStop
              ? `<button class="vcr-stop-btn" title="Stop"><span class="material-icons text-orange-600 hover:text-orange-800">stop_circle</span></button>`
              : (canRestart
                ? `<button class="vcr-restart-btn" title="Restart"><span class="material-icons text-orange-600 hover:text-orange-800">change_circle</span></button>`
                : ''));

        row.innerHTML = `
          <td class="px-2 py-1 whitespace-nowrap">${idShort}</td>
          <td class="px-2 py-1 font-bold ${nameColor}">${displayName}</td>          
          <td class="px-2 py-1 whitespace-nowrap">${sizeDisp}</td>
          <td class="px-2 py-1 whitespace-nowrap">${dimDisp}</td>
          <td class="px-2 py-1 whitespace-nowrap">${durDisp}</td>
          <td class="px-2 py-1 whitespace-nowrap">${codecDisp}</td>
          <td class="px-2 py-1 whitespace-nowrap">${fpsDisp}</td>

          <td class="px-2 py-1 text-center w-28">
            ${progressBar(job.segment_progress || 0)}
            <div class="text-gray-600 text-xs text-center mt-1">
              ${formatElapsed(job.segment_elapsed || 0)} ${segCount}/${totalChunks || '…'}
            </div>
          </td>

          <td class="px-2 py-1 text-center w-28">
            ${progressBar(job.encode_progress || 0)}
            <div class="text-gray-600 text-xs text-center mt-1">
              ${formatElapsed(job.encode_elapsed || 0)} ${encCount}/${totalChunks || '…'}
            </div>
          </td>

          <td class="px-2 py-1 text-center w-28">
            ${progressBar(job.combine_progress || 0)}
            <div class="text-gray-600 text-xs text-center mt-1">
              ${formatElapsed(job.combine_elapsed || 0)} ${stitchedApprox}/${totalChunks || '…'}
            </div>
          </td>
          <td class="px-2 py-1 whitespace-normal break-words">${formatDateTime(job.started)}</td>
          <td class="px-2 py-1">${formatElapsed(job.elapsed)}</td>
          <td class="px-2 py-1">
            <span class="font-medium ${
              job.status === 'READY'  ? 'text-gray-700'  :
              job.status === 'RUNNING'? 'text-blue-600' :
              job.status === 'STOPPED'? 'text-orange-600' :
              job.status === 'FAILED' ? 'text-red-600'  :
              job.status === 'DONE'   ? 'text-green-600':
                                        'text-gray-700'
            }">${job.status || 'READY'}
            </span>          
          </td>
          <td class="px-2 py-1">
            <div class="flex items-center justify-center gap-1">
              ${job.filename && job.filename !== 'undefined'
                ? `<button class="copy-btn" title="Copy"><span class="material-icons text-blue-600 hover:text-blue-800">content_copy</span></button>`
                : ''}
              <button class="delete-btn" title="Delete">
                <span class="material-icons text-red-600 hover:text-red-800">delete</span>
              </button>
              <button class="properties-btn" title="Properties">
                <span class="material-icons text-gray-700 hover:text-black">info</span>
              </button>
              <button class="settings-btn" title="Settings">
                <span class="material-icons text-gray-700 hover:text-black">settings</span>
              </button>
              ${vcrBtnHtml}
            </div>
          </td>
        `;
        jobList.appendChild(row);

        const copyBtn = row.querySelector('.copy-btn');
        if (copyBtn) copyBtn.addEventListener('click', () => copyJob(job.job_id));
        row.querySelector('.delete-btn').addEventListener('click', () => deleteJob(job.job_id));
        row.querySelector('.properties-btn').addEventListener('click', () => showProperties(job.job_id));
        row.querySelector('.settings-btn').addEventListener('click', () => showJobSettings(job.job_id));
        row.querySelector('.vcr-start-btn')?.addEventListener('click', () => startJob(job.job_id));
        row.querySelector('.vcr-stop-btn')?.addEventListener('click', () => stopJob(job.job_id));
        row.querySelector('.vcr-restart-btn')?.addEventListener('click', () => restartJob(job.job_id));
      });
    }

    // poll
    setInterval(() => fetchJobs(false), 5000);
    fetchJobs(false);
  </script>
</body>
</html>
