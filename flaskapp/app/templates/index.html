<!DOCTYPE html>
<html>
<head>
  <title>Video Encoding Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>  
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Video Encoding Manager</h1>
      <div class="flex items-center gap-2">
        <label for="sort-by" class="text-sm text-gray-700">Sort by:</label>
        <select id="sort-by" class="border rounded px-2 py-1 text-sm">
          <option value="date" selected>Date</option>
          <option value="filename">Filename</option>
          <option value="status">Status</option>
          <option value="encode">Encode %</option>
        </select>
        <button id="open-global-settings" class="flex items-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">
          <span class="material-icons">settings</span>
          Global Settings
        </button>
      </div>
    </div>


    <div class="grid grid-cols-3 gap-6">
      <div class="bg-white rounded shadow p-4">
        <div class="flex items-baseline justify-between"><h3 class="font-semibold">GPU %</h3><span id="gpu-updated" class="text-xs text-gray-500"></span></div>
        <div class="w-full h-20">
          <canvas id="gpuChart" class="w-full h-full"></canvas>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4">
        <div class="flex items-baseline justify-between"><h3 class="font-semibold">CPU %</h3><span id="cpu-updated" class="text-xs text-gray-500"></span></div>
        <div class="w-full h-20">
          <canvas id="cpuChart" class="w-full h-full"></canvas>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4">
        <div class="flex items-baseline justify-between"><h3 class="font-semibold">Memory %</h3><span id="mem-updated" class="text-xs text-gray-500"></span></div>
        <div class="w-full h-20">
          <canvas id="memChart" class="w-full h-full"></canvas>
        </div>
      </div>

    </div>    


    <h2 class="text-xl font-semibold mb-2">Current Jobs</h2>

    <table id="job-table" class="w-full border-collapse bg-white">
      <thead>
        <tr class="bg-gray-200">
          <th class="px-2 py-1 text-left">ID</th>
          <th class="px-2 py-1 text-left">Name</th>
          <th class="px-2 py-1 text-left">Size</th>
          <th class="px-2 py-1 text-left">Dim</th>
          <th class="px-2 py-1 text-left">Dur</th>
          <th class="px-2 py-1 text-left">Codec</th>
          <th class="px-2 py-1 text-left">FPS</th>
          <th class="px-2 py-1 text-center">Split</th>
          <th class="px-2 py-1 text-center">Encode</th>
          <th class="px-2 py-1 text-center">Stitch</th>
          <th class="px-2 py-1 text-left">Started</th>
          <th class="px-2 py-1 text-left">Elapsed</th>
          <th class="px-2 py-1 text-left">Status</th>
          <th class="px-2 py-1 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="job-list"></tbody>
    </table>

    <!-- Pagination (server-side) -->
    <div id="pagination" class="flex items-center justify-end gap-2 mt-3">
      <button id="pg-first" class="px-2 py-1 border rounded text-sm">« First</button>
      <button id="pg-prev"  class="px-2 py-1 border rounded text-sm">‹ Prev</button>
      <span id="pg-status"  class="text-sm text-gray-700 mx-2">Page 1 / 1</span>
      <button id="pg-next"  class="px-2 py-1 border rounded text-sm">Next ›</button>
      <button id="pg-last"  class="px-2 py-1 border rounded text-sm">Last »</button>
    </div>    
  </div>

  <!-- Toast container -->
  <div id="toast-root" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <!-- Properties Modal -->
  <div id="properties-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg w-full max-w-2xl p-6 relative">
      <button onclick="closeModal('properties-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
        <span class="material-icons">close</span>
      </button>
      <h2 class="text-xl font-semibold mb-4">Job Properties</h2>
      <div id="properties-content" class="space-y-2 text-sm font-mono whitespace-pre-wrap"></div>
    </div>
  </div>

  <!-- Per-Job Settings Modal -->
  <div id="job-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg w-full max-w-lg p-6 relative">
      <button onclick="closeModal('job-settings-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
        <span class="material-icons">close</span>
      </button>
      <h2 class="text-xl font-semibold mb-4">Job Settings</h2>

      <form id="job-settings-form" class="space-y-4" onsubmit="return false;">
        <input type="hidden" id="settings-job-id" value="">
        <div>
          <label class="block text-sm font-medium mb-1" for="settings-filename">Filename</label>
          <input id="settings-filename" type="text" class="border p-2 rounded w-full" disabled>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="settings-segment-duration">Segment Length (s)</label>
            <input id="settings-segment-duration" type="number" min="1" max="300" class="border p-2 rounded w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="settings-number-parts">Number of Parts</label>
            <input id="settings-number-parts" type="number" min="1" max="8" class="border p-2 rounded w-full">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="settings-v-stream">Video Stream</label>
            <select id="settings-v-stream" class="border p-2 rounded w-full"></select>
            <div class="text-xs text-gray-600 mt-1">Choose which video stream to encode.</div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="settings-a-stream">Audio Stream</label>
            <select id="settings-a-stream" class="border p-2 rounded w-full"></select>
            <div class="text-xs text-gray-600 mt-1">Choose which audio stream to encode.</div>
          </div>
        </div>        
        <div class="flex items-center gap-2">
          <input id="job-serialize-pipeline" type="checkbox" class="h-4 w-4">
          <label for="job-serialize-pipeline" class="text-sm">
            Serialize pipeline for this job
          </label>
        </div>
        <div class="flex gap-2 pt-2">
          <button id="save-job-settings-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hidden">Save</button>
          <button id="start-job-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">Start Job</button>
          <button type="button" class="ml-auto bg-gray-200 px-4 py-2 rounded hover:bg-gray-300" onclick="closeModal('job-settings-modal')">Close</button>
        </div>
        <div id="job-settings-help" class="text-xs text-gray-600"></div>
      </form>
    </div>
  </div>

  <!-- Global Settings Modal -->
  <div id="global-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg w-full max-w-lg p-6 relative">
      <button onclick="closeModal('global-settings-modal')" class="absolute top-2 right-2 text-gray-600 hover:text-black">
        <span class="material-icons">close</span>
      </button>
      <h2 class="text-xl font-semibold mb-4">Global Settings</h2>
      <form id="global-settings-form" class="space-y-4" onsubmit="return false;">
        <div>
          <label class="block text-sm font-medium mb-1" for="global-segment-duration">Segment Length (seconds)</label>
          <input id="global-segment-duration" type="number" min="1" max="300" class="border p-2 rounded w-full">
          <div class="text-xs text-gray-600 mt-1">Enter 1–300 seconds. Default is 10.</div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="global-number-parts">Number of Parts</label>
          <input id="global-number-parts" type="number" min="1" max="8" class="border p-2 rounded w-full">
          <div class="text-xs text-gray-600 mt-1">Split the video into 1–8 parts. Default is 2.</div>
        </div>
        <div class="flex items-center gap-2">
          <input id="global-auto-start" type="checkbox" class="h-4 w-4">
          <label for="global-auto-start" class="text-sm">Automatically start encode jobs</label>
        </div>
        <div class="flex items-center gap-2">
          <input id="global-serialize-pipeline" type="checkbox" class="h-4 w-4">
          <label for="global-serialize-pipeline" class="text-sm">
            Serialize pipeline (split → encode → stitch)
          </label>
        </div>        
        <div class="flex gap-2 pt-2">
          <button id="save-global-settings-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
          <button type="button" class="ml-auto bg-gray-200 px-4 py-2 rounded hover:bg-gray-300" onclick="closeModal('global-settings-modal')">Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Video Preview Modal -->
  <div id="video-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 items-center justify-center">
    <div class="bg-white rounded shadow-xl w-full max-w-5xl relative">
      <button onclick="closeVideoModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">
        <span class="material-icons">close</span>
      </button>

      <div class="p-4">
        <h3 id="video-title" class="text-lg font-semibold mb-2"></h3>
        <video id="video-player" class="w-full bg-black" controls playsinline></video>

        <div class="flex items-center gap-2 mt-3">
          <button id="btn-back-frame" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">
            <span class="material-icons align-middle">skip_previous</span> Frame -
          </button>
          <button id="btn-fwd-frame" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">
            Frame + <span class="material-icons align-middle">skip_next</span>
          </button>
          <div class="ml-auto text-xs text-gray-600">
            <span id="video-fps-label"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- helpers ---
    const BLUE_FILL  = 'rgba(37, 99, 235, 0.85)'; // tailwind blue-600-ish
    const BLUE_STROKE= 'rgb(37, 99, 235)';
  
    const el = id => document.getElementById(id);
    const shortHost = h => {
      if (!h) return '';
      const m = String(h).match(/(\d+)/);
      return m ? m[1] : h; // show just the number
    };
    const tsStr = ts => new Date(ts * 1000).toLocaleTimeString();
  
    const tinyBarOpts = (maxY = 100) => ({
      type: 'bar',
      data: { labels: [], datasets: [{ data: [], backgroundColor: BLUE_FILL, borderColor: BLUE_STROKE, borderWidth: 1 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false, // honor the 80px (h-20) height
        animation: false,
        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
        scales: {
          x: {
            grid: { display: false },
            ticks: { autoSkip: false, maxRotation: 0, minRotation: 0, font: { size: 10 } }
          },
          y: {
            beginAtZero: true,
            suggestedMax: maxY,
            grid: { display: false },
            ticks: { stepSize: 50, font: { size: 10 } }
          }
        }
      }
    });
  
    const gpuChart = new Chart(el('gpuChart').getContext('2d'), tinyBarOpts(100));
    const cpuChart = new Chart(el('cpuChart').getContext('2d'), tinyBarOpts(100));
    const memChart = new Chart(el('memChart').getContext('2d'), tinyBarOpts(100));
  
    function updateBars(chart, labels, values, suggestedMax) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      if (suggestedMax !== undefined) chart.options.scales.y.suggestedMax = suggestedMax;
      chart.update();
    }
  
    async function fetchMetrics() {
      try {
        const res = await fetch('/metrics_snapshot');
        if (!res.ok) return;
        const { nodes } = await res.json();
  
        // Sort by node number so columns are stable left→right
        nodes.sort((a, b) => {
          const na = parseInt((a.hostname || '').match(/\d+/)?.[0] || 0, 10);
          const nb = parseInt((b.hostname || '').match(/\d+/)?.[0] || 0, 10);
          return na - nb;
        });
  
        const labels = nodes.map(n => shortHost(n.hostname));
        const gpu = nodes.map(n => (n.gpu >= 0 ? Number(n.gpu.toFixed(1)) : 0));
        const cpu = nodes.map(n => Number((n.cpu || 0).toFixed(1)));
        const mem = nodes.map(n => {
          const used = Number(n.mem_used || 0), total = Number(n.mem_total || 0);
          const pct = total ? (used / total) * 100 : 0;
          return Number(pct.toFixed(1));
        });
  
        updateBars(gpuChart, labels, gpu, 100);
        updateBars(cpuChart, labels, cpu, 100);
        updateBars(memChart, labels, mem, 100);
  
        const latestTs = nodes.length ? Math.max(...nodes.map(n => n.ts || 0)) : 0;
        const stamp = latestTs ? tsStr(latestTs) : '';
        el('gpu-updated').textContent = stamp;
        el('cpu-updated').textContent = stamp;
        el('mem-updated').textContent = stamp;
      } catch { /* ignore transient errors */ }
    }
  
    // 1 Hz updates
    fetchMetrics();
    setInterval(fetchMetrics, 1000);
  </script>

  <script>

    // ---- Server-side pagination + sorting ----
    let CURRENT_PAGE = 1;            // 1-based
    const PAGE_SIZE = 10;            // fixed as requested
    let CURRENT_SORT = 'date';       // 'date'|'filename'|'status'|'encode'
    let CURRENT_DIR  = 'desc';       // 'asc'|'desc'

    function applyPagerState(meta) {
      const { page, total_pages } = meta;
      CURRENT_PAGE = page;

      const status = document.getElementById('pg-status');
      status.textContent = `Page ${page} / ${total_pages}`;

      document.getElementById('pg-first').disabled = page <= 1;
      document.getElementById('pg-prev').disabled  = page <= 1;
      document.getElementById('pg-next').disabled  = page >= total_pages;
      document.getElementById('pg-last').disabled  = page >= total_pages;

      // store last meta for next/last buttons
      window.__PAGER_META__ = meta;
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('pg-first').addEventListener('click', () => { CURRENT_PAGE = 1; fetchJobs(false); });
      document.getElementById('pg-prev').addEventListener('click',  () => { CURRENT_PAGE = Math.max(1, CURRENT_PAGE - 1); fetchJobs(false); });
      document.getElementById('pg-next').addEventListener('click',  () => {
        const meta = window.__PAGER_META__ || { total_pages: CURRENT_PAGE };
        CURRENT_PAGE = Math.min(meta.total_pages, CURRENT_PAGE + 1);
        fetchJobs(false);
      });
      document.getElementById('pg-last').addEventListener('click',  () => {
        const meta = window.__PAGER_META__ || { total_pages: CURRENT_PAGE };
        CURRENT_PAGE = meta.total_pages;
        fetchJobs(false);
      });

      // If you already have a sort <select id="sort-by">, map to server fields:
      const sortSel = document.getElementById('sort-by');
      if (sortSel) {
        sortSel.addEventListener('change', (e) => {
          const v = e.target.value || 'date';
          CURRENT_SORT = v;    // our server expects same enum names you used
          CURRENT_PAGE = 1;    // reset to first page on sort change
          fetchJobs(false);
        });
      }
    });

    // ---------- Utils ----------
    function statusColorClass(status = '') {
      const s = String(status || '').toUpperCase();
      if (s === 'READY') return 'text-yellow-600';
      if (s === 'RUNNING') return 'text-blue-600';
      if (s === 'STOPPED') return 'text-gray-600';
      if (s === 'FAILED') return 'text-red-600';
      if (s === 'DONE' || s === 'COMPLETED') return 'text-green-600';
      if (s.startsWith('SEG') || s.startsWith('ENC') || s.includes('STITCH')) return 'text-blue-600';
      if (s === 'ABORTED') return 'text-gray-600';
      if (s === 'QUEUED' || s === 'PAUSED') return 'text-yellow-600';
      return 'text-black';
    }

    function prettyTitleFromPath(path = '') {
      const base = (path.split('/').pop() || '').replace(/\.[^.]+$/, '').trim();
      const tvMatch = base.match(/^(.+?)\s*-\s*([^-\n]+)\s*-\s*.*$/);
      if (tvMatch) {
        const show = tvMatch[1].trim();
        const ep   = tvMatch[2].trim();
        return `${show} - ${ep}`;
      }
      const movieMatch = base.match(/^(.+?)\s*\[\s*\d{4}.*\]$/);
      if (movieMatch) return movieMatch[1].trim();
      return base || path.split('/').pop() || 'N/A';
    }
    function toast(message, ok = true) {
      const root = document.getElementById('toast-root');
      const el = document.createElement('div');
      el.className = `px-3 py-2 rounded text-white shadow ${ok ? 'bg-green-600' : 'bg-red-600'}`;
      el.textContent = message;
      root.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function formatElapsed(seconds) {
      if (seconds == null || isNaN(seconds)) return '';
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${String(s).padStart(2, '0')}`;
    }
    function formatDateTime(timestamp) {
      if (!timestamp || isNaN(timestamp)) return '';
      const dt = new Date(timestamp * 1000);
      return dt.toLocaleString();
    }
    function formatBytes(bytes) {
      const b = Number(bytes);
      if (!b || b < 0) return '…';
      const units = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(b) / Math.log(1024));
      const v = b / Math.pow(1024, i);
      return `${v.toFixed(v >= 10 ? 0 : 1)} ${units[i]}`;
    }
    function formatDurationSeconds(secStr) {
      const s = parseFloat(secStr);
      if (!isFinite(s) || s <= 0) return '…';
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const s2 = Math.floor(s % 60);
      return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(s2).padStart(2,'0')}`
                   : `${m}:${String(s2).padStart(2,'0')}`;
    }
    function formatFPS(val) {
      const n = parseFloat(val);
      if (!isFinite(n) || n <= 0) return '…';
      return n.toFixed(n >= 100 ? 0 : 2);
    }
    function progressBar(percent) {
      percent = Number(percent || 0);
      return `
        <div class="relative w-full h-4 bg-gray-200 rounded">
          <div class="absolute top-0 left-0 h-4 rounded bg-blue-500" style="width: ${percent}%"></div>
          <div class="absolute inset-0 text-center text-xs leading-4 font-medium text-black">${percent}%</div>
        </div>
      `;
    }
    function stackedSrcDst(src, dst, showDst) {
      if (!showDst || !dst) return src;
      return `
        <div class="leading-tight">
          <div>${src}</div>
          <div>${dst}</div>
        </div>
      `;
    }    

    // ---------- Global Settings ----------
    async function showGlobalSettings() {
      const res = await fetch('/global_settings');
      if (!res.ok) return alert('Failed to load global settings');
      const data = await res.json();
      document.getElementById('global-segment-duration').value = data.segment_duration ?? 10;
      document.getElementById('global-number-parts').value = data.number_parts ?? 2;
      document.getElementById('global-auto-start').checked = !!data.auto_start;
      document.getElementById('global-serialize-pipeline').checked = !!data.serialize_pipeline;      
      document.getElementById('global-settings-modal').classList.remove('hidden');
    }
    async function saveGlobalSettings() {
      const segment_duration = parseInt(document.getElementById('global-segment-duration').value, 10);
      const number_parts = parseInt(document.getElementById('global-number-parts').value, 10);
      const auto_start = document.getElementById('global-auto-start').checked;
      const serialize_pipeline = document.getElementById('global-serialize-pipeline').checked;
      const res = await fetch('/global_settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ segment_duration, number_parts, auto_start, serialize_pipeline })
      });
      if (res.ok) {
        toast('Saved global settings', true);
        closeModal('global-settings-modal');
      } else {
        const msg = await res.text();
        toast(msg || 'Failed to save global settings', false);
      }
    }
    document.getElementById('open-global-settings').addEventListener('click', showGlobalSettings);
    document.getElementById('save-global-settings-btn').addEventListener('click', saveGlobalSettings);

    // ---------- Job Info / Properties ----------
    async function showProperties(job_id) {
      const res = await fetch(`/job_properties/${job_id}`);
      if (!res.ok) return alert('Failed to load properties');
      const data = await res.json();
      document.getElementById('properties-content').innerText = JSON.stringify(data, null, 2);
      document.getElementById('properties-modal').classList.remove('hidden');
    }

    // ---------- Per-Job Settings ----------
    async function showJobSettings(job_id) {
      const res = await fetch(`/job_settings/${job_id}`);
      if (!res.ok) return alert('Failed to load settings');
      const data = await res.json();
      console.log(data)

      const editable = ['READY','STOPPED','FAILED'].includes(String(data.status || '').toUpperCase());

      document.getElementById('settings-job-id').value = job_id;
      document.getElementById('settings-filename').value = data.filename || '';
      document.getElementById('settings-segment-duration').value = data.segment_duration || 10;
      document.getElementById('settings-number-parts').value = data.number_parts || 2;
      document.getElementById('job-serialize-pipeline').checked =
        String(data.serialize_pipeline) === '1' || data.serialize_pipeline === true;
      document.getElementById('job-serialize-pipeline').disabled = !editable;

      // Streams
      const vSel = document.getElementById('settings-v-stream');
      const aSel = document.getElementById('settings-a-stream');
      vSel.innerHTML = '';
      aSel.innerHTML = '';

      const streams = JSON.parse(data.streams || {}) ;
      const vids = streams.video || [];
      const auds = streams.audio || [];
      console.log(vids)
      console.log(auds)

      vids.forEach((v,idx) => {
        const label = [
          `#${idx}`, v.codec || '',
          v.width && v.height ? `${v.width}x${v.height}` : '',
          v.fps ? `${Number(v.fps).toFixed(2)}fps` : '',
          v.title ? `“${v.title}”` : ''
        ].filter(Boolean).join(' · ');
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = label;
        vSel.appendChild(opt);
      });

      auds.forEach((a,idx) => {
        const label = [
          `#${idx}`, a.codec || '',
          a.channel_layout || (a.channels ? `${a.channels}ch` : ''),
          a.language || '',
          a.title ? `“${a.title}”` : '',
          a.disposition_default ? '(default)' : ''
        ].filter(Boolean).join(' · ');
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = label;
        aSel.appendChild(opt);
      });

      function setSelectIndexByValue(sel, val, fallback = 0) {
        if (!sel || sel.options.length === 0) return;
        let idx = parseInt(val, 10);
        if (Number.isNaN(idx)) idx = fallback;
        if (idx < 0 || idx >= sel.options.length) idx = fallback;
        sel.selectedIndex = idx;
      }

      // Preselect current choices (fallback to first if missing/out of range)
      setSelectIndexByValue(vSel, data.selected_v_stream, 0);
      setSelectIndexByValue(aSel, data.selected_a_stream, 0);

      // Enable/disable inputs
      document.getElementById('settings-segment-duration').disabled = !editable;
      document.getElementById('settings-number-parts').disabled = !editable;
      vSel.disabled = !editable;
      aSel.disabled = !editable;

      // Show buttons
      document.getElementById('save-job-settings-btn').classList.toggle('hidden', !editable);
      document.getElementById('start-job-btn').classList.toggle('hidden', !(String(data.status).toUpperCase() === 'READY'));

      document.getElementById('job-settings-help').innerHTML = editable
        ? 'You can adjust settings before starting (READY) or before restarting (STOPPED/FAILED).'
        : 'This job is active or finished. Settings are read-only.';

      document.getElementById('save-job-settings-btn').onclick = saveJobSettings;
      document.getElementById('start-job-btn').onclick = () => startJob(job_id);

      document.getElementById('job-settings-modal').classList.remove('hidden');
    }

    async function saveJobSettings() {
      const job_id = document.getElementById('settings-job-id').value;
      const segment_duration = parseInt(document.getElementById('settings-segment-duration').value, 10);
      const number_parts = parseInt(document.getElementById('settings-number-parts').value, 10);

      const vSel = document.getElementById('settings-v-stream');
      const aSel = document.getElementById('settings-a-stream');
      const selected_v_stream = vSel.selectedIndex; // not vSel.value
      const selected_a_stream = aSel.selectedIndex; // not aSel.value      
      const serialize_pipeline = document.getElementById('job-serialize-pipeline').checked;

      const res = await fetch(`/job_settings/${job_id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          segment_duration, number_parts,
          selected_v_stream, selected_a_stream,
          serialize_pipeline
        })
      });
      if (res.ok) {
        closeModal('job-settings-modal');
        fetchJobs();
      } else {
        const msg = await res.text();
        alert(msg || 'Failed to save settings');
      }
    }


    // ---------- Jobs CRUD ----------
    async function copyJob(job_id) {
      try {
        const response = await fetch('/copy_job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id })
        });
        const result = await response.json();
        if (response.ok && result.status === 'success') {
          toast(`Copied job ${job_id.split('-')[0]} → ${result.job_id.split('-')[0]} (PAUSED)`, true);
          fetchJobs();
        } else {
          throw new Error(result.message || 'Failed to copy job');
        }
      } catch (err) {
        toast(`Copy failed: ${err.message}`, false);
      }
    }

    async function deleteJob(job_id) {
      if (!confirm('Delete this job?')) return;
      const response = await fetch(`/delete_job/${job_id}`, { method: 'DELETE' });
      if (response.ok) fetchJobs(); else alert('Failed to delete job');
    }

    async function stopJob(job_id) {
      if (!confirm('Stop this job? This will abort all tasks but keep the project directory.')) return;
      const response = await fetch(`/stop_job/${job_id}`, { method: 'POST' });
      if (response.ok) fetchJobs(); else alert('Failed to stop job');
    }

    async function startJob(job_id) {
      const response = await fetch(`/start_job/${job_id}`, { method: 'POST' });
      if (response.ok) fetchJobs(); else alert('Failed to start job');
    }

    async function restartJob(job_id) {
      const response = await fetch(`/restart_job/${job_id}`, { method: 'POST' });
      if (response.ok) fetchJobs(); else alert('Failed to restart job');
    }

    // ---------- Video preview helpers ----------
    let __videoFPS__ = 30;
    function openVideoModal(title, jobId, fps) {
      // FPS (fallback to 30 if invalid)
      __videoFPS__ = (Number(fps) > 0) ? Number(fps) : 30;

      const modal  = document.getElementById('video-modal');
      const player = document.getElementById('video-player');
      const label  = document.getElementById('video-fps-label');
      const titleEl = document.getElementById('video-title');

      // Set UI text
      titleEl.textContent = String(title || '');
      label.textContent   = `FPS: ${__videoFPS__.toFixed(2)}`;

      // Prepare player
      player.pause();
      player.removeAttribute('src');
      player.load();

      // Safe, encoded preview URL
      const url = `/preview/${encodeURIComponent(jobId)}`;
      player.src = url;

      // Reset time & load fresh
      player.currentTime = 0;
      player.load();

      // Show modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      // Try autoplay (ignore if blocked)
      player.play().catch(() => { /* autoplay might be blocked; that's fine */ });

      // Focus for key controls
      player.focus();
    }
    function closeVideoModal() {
      const modal  = document.getElementById('video-modal');
      const player = document.getElementById('video-player');
      player.pause();
      player.removeAttribute('src');
      player.load();
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    function stepFrame(delta) {
      const player = document.getElementById('video-player');
      if (!player) return;
      const step = 1 / (__videoFPS__ || 30);
      player.pause();
      const target = Math.max(0, player.currentTime + delta * step);
      player.currentTime = target;
    }
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-back-frame').addEventListener('click', () => stepFrame(-1));
      document.getElementById('btn-fwd-frame').addEventListener('click', () => stepFrame(1));
      document.addEventListener('keydown', (e) => {
        const modal = document.getElementById('video-modal');
        if (modal.classList.contains('hidden')) return;
        if (e.key === 'ArrowLeft')  { e.preventDefault(); stepFrame(-1); }
        if (e.key === 'ArrowRight') { e.preventDefault(); stepFrame(1);  }
      });
    });

    // ---------- Sorting ----------

    function statusRank(s) {
      const order = {
        'READY': 0,
        'RUNNING': 1,
        'STOPPED': 2,
        'FAILED': 3,
        'DONE': 4
      };
      return order[s] ?? 99;
    }

    function compareJobs(a, b) {
      switch (CURRENT_SORT) {
        case 'filename': {
          const af = (a.filename || '').toLowerCase();
          const bf = (b.filename || '').toLowerCase();
          if (af < bf) return -1;
          if (af > bf) return 1;
          return 0;
        }
        case 'status': {
          const ar = statusRank(a.status || '');
          const br = statusRank(b.status || '');
          if (ar !== br) return ar - br;
          const af = (a.filename || '').toLowerCase();
          const bf = (b.filename || '').toLowerCase();
          if (af < bf) return -1;
          if (af > bf) return 1;
          return 0;
        }
        case 'encode': {
          const ae = Number(a.encode_progress || 0);
          const be = Number(b.encode_progress || 0);
          if (ae !== be) return be - ae;
          if (a.started !== b.started) return b.started - a.started;
          const af = (a.filename || '').toLowerCase();
          const bf = (b.filename || '').toLowerCase();
          if (af < bf) return -1;
          if (af > bf) return 1;
          return 0;
        }
        case 'date':
        default: {
          const aPaused = Number(a.started || 0) === 0;
          const bPaused = Number(b.started || 0) === 0;
          if (aPaused && bPaused) {
            return Number(b.created || 0) - Number(a.created || 0);
          }
          if (aPaused && !bPaused) return -1;
          if (!aPaused && bPaused) return 1;
          return Number(b.started || 0) - Number(a.started || 0);
        }
      }
    }

    document.getElementById('sort-by').addEventListener('change', (e) => {
      CURRENT_SORT = e.target.value || 'date';
      fetchJobs(true); // re-render using cache
    });

    // ---------- Table render ----------
    async function fetchJobs(skipFetch = false) {
      // skipFetch is ignored now; we always ask the server for the current page
      const params = new URLSearchParams({
        page: String(CURRENT_PAGE),
        page_size: String(PAGE_SIZE),
        sort_by: CURRENT_SORT,
        sort_dir: CURRENT_DIR
      });
      const response = await fetch(`/jobs?${params.toString()}`);
      if (!response.ok) return;
      const payload = await response.json();

      // Back-compat path (if server returned a raw array)
      const items = Array.isArray(payload) ? payload : (payload.items || []);
      const meta  = Array.isArray(payload)
        ? { page: 1, total_pages: 1, total: items.length, page_size: items.length }
        : { page: payload.page, total_pages: payload.total_pages, total: payload.total, page_size: payload.page_size };

      // cache only current page if you want
      window.__JOBS_CACHE__ = items;

      const jobList = document.getElementById('job-list');
      jobList.innerHTML = '';

      items.forEach(job => {
        const row = document.createElement('tr');

        const idShort = (job.job_id || '').split('-')[0] || '';
        const displayName = prettyTitleFromPath(job.filename || '');
        const nameColor = statusColorClass(job.status || '');

        const canStart   = job.status === 'READY';
        const canStop    = job.status === 'RUNNING';
        const canRestart = (job.status === 'STOPPED' || job.status === 'FAILED'  || job.status === 'DONE');

        const totalChunks = Number(job.total_chunks || 0);
        const segCount    = Number(job.segmented_chunks || 0);
        const encCount    = Number(job.completed_chunks || 0);
        const stitchedApprox = totalChunks > 0 ? Math.floor((Number(job.combine_progress || 0) / 100) * totalChunks) : 0;

        const vcrBtnHtml = canStart
          ? `<button class="vcr-start-btn" title="Start"><span class="material-icons text-green-600 hover:text-green-800">play_circle</span></button>`
          : (canStop
              ? `<button class="vcr-stop-btn" title="Stop"><span class="material-icons text-orange-600 hover:text-orange-800">stop_circle</span></button>`
              : (canRestart
                ? `<button class="vcr-restart-btn" title="Restart"><span class="material-icons text-orange-600 hover:text-orange-800">change_circle</span></button>`
                : ''));

        const isDone = String(job.status || '').toUpperCase() === 'DONE';
        const nameCellHTML = isDone
          ? `<button class="font-bold underline ${nameColor} hover:opacity-80 name-preview"
              title="Preview"
              data-title="${displayName.replace(/"/g, '&quot;')}"
              data-jobid="${job.job_id}"
              data-fps="${Number(job.source_fps || 0)}">
              ${displayName}
            </button>`
          : `<span class="font-bold ${nameColor}">${displayName}</span>`;

          // Src displays (existing)
          const sizeDisp = formatBytes(job.source_file_size);
          const dimDisp  = job.source_resolution || '…';
          const durDisp  = formatDurationSeconds(job.source_duration);
          const codecDisp= job.source_codec || '…';
          const fpsDisp  = formatFPS(job.source_fps);

          // Dst displays (NEW)
          const sizeDst  = formatBytes(job.dest_file_size);
          const dimDst   = job.dest_resolution || '…';
          const durDst   = formatDurationSeconds(job.dest_duration);
          const codecDst = job.dest_codec || '…';
          const fpsDst   = formatFPS(job.dest_fps);

          // Show Dst only when DONE and we have *some* dst signal
          const showDst  = isDone && (
            job.dest_file_size || job.dest_resolution || job.dest_duration ||
            job.dest_codec || job.dest_fps
          );

        row.innerHTML = `
          <td class="px-2 py-1 whitespace-nowrap">${idShort}</td>
          <td class="px-2 py-1">${nameCellHTML}</td>
          <td class="px-2 py-1">
            ${stackedSrcDst(sizeDisp,  sizeDst,  showDst)}
          </td>
          <td class="px-2 py-1">
            ${stackedSrcDst(dimDisp,   dimDst,   showDst)}
          </td>
          <td class="px-2 py-1">
            ${stackedSrcDst(durDisp,   durDst,   showDst)}
          </td>
          <td class="px-2 py-1">
            ${stackedSrcDst(codecDisp, codecDst, showDst)}
          </td>
          <td class="px-2 py-1">
            ${stackedSrcDst(fpsDisp,   fpsDst,   showDst)}
          </td>
          <td class="px-2 py-1 text-center w-28">
            ${progressBar(job.segment_progress || 0)}
            <div class="text-gray-600 text-xs text-center mt-1">
              ${formatElapsed(job.segment_elapsed || 0)} ${segCount}/${totalChunks || '…'}
            </div>
          </td>

          <td class="px-2 py-1 text-center w-28">
            ${progressBar(job.encode_progress || 0)}
            <div class="text-gray-600 text-xs text-center mt-1">
              ${formatElapsed(job.encode_elapsed || 0)} ${encCount}/${totalChunks || '…'}
            </div>
          </td>

          <td class="px-2 py-1 text-center w-28">
            ${progressBar(job.combine_progress || 0)}
            <div class="text-gray-600 text-xs text-center mt-1">
              ${formatElapsed(job.combine_elapsed || 0)} ${stitchedApprox}/${totalChunks || '…'}
            </div>
          </td>
          <td class="px-2 py-1 whitespace-normal break-words">${formatDateTime(job.started)}</td>
          <td class="px-2 py-1">${formatElapsed(job.elapsed)}</td>
          <td class="px-2 py-1">
            <span class="font-medium ${
              job.status === 'READY'  ? 'text-gray-700'  :
              job.status === 'RUNNING'? 'text-blue-600' :
              job.status === 'STOPPED'? 'text-orange-600' :
              job.status === 'FAILED' ? 'text-red-600'  :
              job.status === 'DONE'   ? 'text-green-600':
                                        'text-gray-700'
            }">${job.status || 'READY'}</span>
          </td>
          <td class="px-2 py-1">
            <div class="flex items-center justify-center gap-1">
              ${job.filename && job.filename !== 'undefined'
                ? `<button class="copy-btn" title="Copy"><span class="material-icons text-blue-600 hover:text-blue-800">content_copy</span></button>`
                : ''}
              <button class="delete-btn" title="Delete">
                <span class="material-icons text-red-600 hover:text-red-800">delete</span>
              </button>
              <button class="properties-btn" title="Properties">
                <span class="material-icons text-gray-700 hover:text-black">info</span>
              </button>
              <button class="settings-btn" title="Settings">
                <span class="material-icons text-gray-700 hover:text-black">settings</span>
              </button>
              ${vcrBtnHtml}
            </div>
          </td>
        `;
        jobList.appendChild(row);

        const previewBtn = row.querySelector('.name-preview');
        if (previewBtn) {
          previewBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const title = previewBtn.dataset.title || displayName;
            const jobId = previewBtn.dataset.jobid;
            const fps   = Number(previewBtn.dataset.fps || job.source_fps || 0);
            if (jobId) openVideoModal(title, jobId, fps);
          });
        }
        const copyBtn = row.querySelector('.copy-btn');
        if (copyBtn) copyBtn.addEventListener('click', () => copyJob(job.job_id));
        row.querySelector('.delete-btn').addEventListener('click', () => deleteJob(job.job_id));
        row.querySelector('.properties-btn').addEventListener('click', () => showProperties(job.job_id));
        row.querySelector('.settings-btn').addEventListener('click', () => showJobSettings(job.job_id));
        row.querySelector('.vcr-start-btn')?.addEventListener('click', () => startJob(job.job_id));
        row.querySelector('.vcr-stop-btn')?.addEventListener('click', () => stopJob(job.job_id));
        row.querySelector('.vcr-restart-btn')?.addEventListener('click', () => restartJob(job.job_id));
      });

      applyPagerState(meta);
    }

    // poll
    setInterval(() => fetchJobs(false), 5000);
    fetchJobs(false);
  </script>
</body>
</html>
